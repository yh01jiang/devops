apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-config
  namespace: tensuns
data:
  config.yml: |-
    global:
      # å½“alertmanageræŒç»­å¤šé•¿æ—¶é—´æœªæ¥æ”¶åˆ°å‘Šè­¦åæ ‡è®°å‘Šè­¦çŠ¶æ€ä¸º resolved
      resolve_timeout: 5m
      # é…ç½®é‚®ä»¶å‘é€ä¿¡æ¯
      smtp_smarthost: 'smtpdm.aliyun.com:465'
      smtp_from: 'devops-monitor@smtp.*.com'
      smtp_auth_username: 'devops-monitor@smtp.kerryplu*s.com'
      smtp_auth_password: '*****'
      smtp_hello: 'smtp.*.com'
      smtp_require_tls: false
    # æ‰€æœ‰æŠ¥è­¦ä¿¡æ¯è¿›å…¥åçš„æ ¹è·¯ç”±ï¼Œç”¨æ¥è®¾ç½®æŠ¥è­¦çš„åˆ†å‘ç­–ç•¥
    route:
      # è¿™é‡Œçš„æ ‡ç­¾åˆ—è¡¨æ˜¯æ¥æ”¶åˆ°æŠ¥è­¦ä¿¡æ¯åçš„é‡æ–°åˆ†ç»„æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶åˆ°çš„æŠ¥è­¦ä¿¡æ¯é‡Œé¢æœ‰è®¸å¤šå…·æœ‰ cluster=A å’Œ alertname=LatncyHigh è¿™æ ·çš„æ ‡ç­¾çš„æŠ¥è­¦ä¿¡æ¯å°†ä¼šæ‰¹é‡è¢«èšåˆåˆ°ä¸€ä¸ªåˆ†ç»„é‡Œé¢
      group_by: ['alertname', 'cluster']
      # å½“ä¸€ä¸ªæ–°çš„æŠ¥è­¦åˆ†ç»„è¢«åˆ›å»ºåï¼Œéœ€è¦ç­‰å¾…è‡³å°‘ group_wait æ—¶é—´æ¥åˆå§‹åŒ–é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æ‚¨èƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„æ¥è·å–å¤šä¸ªè­¦æŠ¥ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªæŠ¥è­¦ä¿¡æ¯ã€‚
      group_wait: 30s

      # ç›¸åŒçš„groupä¹‹é—´å‘é€å‘Šè­¦é€šçŸ¥çš„æ—¶é—´é—´éš”
      group_interval: 30s

      # å¦‚æœä¸€ä¸ªæŠ¥è­¦ä¿¡æ¯å·²ç»å‘é€æˆåŠŸäº†ï¼Œç­‰å¾… repeat_interval æ—¶é—´æ¥é‡æ–°å‘é€ä»–ä»¬ï¼Œä¸åŒç±»å‹å‘Šè­¦å‘é€é¢‘ç‡éœ€è¦å…·ä½“é…ç½®
      repeat_interval: 5m

      # é»˜è®¤çš„receiverï¼šå¦‚æœä¸€ä¸ªæŠ¥è­¦æ²¡æœ‰è¢«ä¸€ä¸ªrouteåŒ¹é…ï¼Œåˆ™å‘é€ç»™é»˜è®¤çš„æ¥æ”¶å™¨
      receiver: default

      # ä¸Šé¢æ‰€æœ‰çš„å±æ€§éƒ½ç”±æ‰€æœ‰å­è·¯ç”±ç»§æ‰¿ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ¯ä¸ªå­è·¯ç”±ä¸Šè¿›è¡Œè¦†ç›–ã€‚
      routes:
      # åŒæ—¶æŠŠå‘Šè­¦ä¿¡æ¯å‘é€ç»™é‚®ç®±ä»¥åŠé’‰é’‰
      - receiver: email-and-dingtalk
        group_wait: 10s
        group_by: ['instance','alertname'] # æ ¹æ®instanceåšåˆ†ç»„
 
      # å‘Šè­¦ä¿¡æ¯å‘åŠ¨ç»™é‚®ç®±ï¼Œé€šè¿‡æ ‡ç­¾severity: warningåŒºåˆ†å‘é€æ¸ é“
      #- receiver: email
      #  group_wait: 10s
      #  match:
      #    severity: warning  # # é€šè¿‡æ ‡ç­¾åŒ¹é…,åªè¦å‘Šè­¦ä¸­æœ‰å¯¹åº”çš„æ ‡ç­¾å³å¯è¿›è¡Œæ‹†åˆ†è¿‡æ»¤ã€‚
      #  group_by: ['instance','alertname'] # æ ¹æ®instanceåšåˆ†ç»„
      # å‘Šè­¦ä¿¡æ¯å‘åŠ¨ç»™é’‰é’‰ï¼Œé€šè¿‡æ ‡ç­¾severity: criticalåŒºåˆ†å‘é€æ¸ é“
      #- receiver: dingtalk-webhook  #  # å…³é”®ï¼šåŒ¹é…éœ€è¦å‘é€åˆ°é’‰é’‰çš„å‘Šè­¦
      #  group_wait: 10s 
      #  match:  #ç²¾å‡†åŒ¹é…ï¼Œmatch_re: æ­£åˆ™åŒ¹é…
      #    severity: critical  # # é€šè¿‡æ ‡ç­¾åŒ¹é…
    
 
      # å¯ä»¥å‚è€ƒé…ç½®
      #- receiver: slack
      #  group_wait: 10s 
      #  match_re:  #æ­£åˆ™åŒ¹é…
      #    team: (frontend|backend)  # åŒ¹é… frontend/backend å›¢é˜Ÿç›¸å…³å‘Šè­¦
      #- receiver: 'webhook-wx'i
      #  continue: false  # å‘Šè­¦åªèƒ½åŒ¹é…ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„è·¯ç”±   # continue: true:å…è®¸å‘Šè­¦åœ¨åŒ¹é…å½“å‰è·¯ç”±è§„åˆ™åç»§ç»­å‘ä¸‹åŒ¹é…å…¶ä»–åŒçº§,å‘Šè­¦å¯åŒ¹é…å¤šä¸ªè·¯ç”±ï¼Œå‘é€åˆ°å¤šä¸ªæ¥æ”¶å™¨
      #  match_re:  #ä»£è¡¨æ­£åˆ™
      #    alertname: .*
    
    # æŠ‘åˆ¶è§„åˆ™ 
    inhibit_rules:      #   æŠ‘åˆ¶è§„åˆ™å¿…é¡»æ”¾åœ¨è¿™é‡Œï¼ˆä¸ route åŒçº§ï¼‰
    - source_match:   # æºå‘Šè­¦åŒ¹é…æ¡ä»¶
        severity: critical
      target_match:   # è¢«æŠ‘åˆ¶çš„ç›®æ ‡å‘Šè­¦æ¡ä»¶
        severity: warning
      equal: ['alertname', 'instance']  # ä¸¤è€…éœ€å…±äº«è¿™äº›æ ‡ç­¾æ‰ä¼šè§¦å‘æŠ‘åˆ¶
       
    templates:  # å¢åŠ  templates é…ç½®ï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶
    - '/etc/alertmanager/template_email.tmpl'

    receivers:  # æ¥æ”¶å™¨
    # æ¥æ”¶å™¨åŒæ—¶å‘é€å‘Šè­¦åˆ°é‚®ç®±ä»¥åŠé’‰é’‰,email-and-dingtalk ä¸ä¸Šæ–‡çš„routesä¸­ç›¸å¯¹åº”
    - name: 'email-and-dingtalk'
      email_configs:
      - to: 'barry.jiang@kerryprops.com'
        send_resolved: true
        html: '{{ template "email.html" . }}' # æ­¤å¤„é€šè¿‡ html æŒ‡å®šæ¨¡æ¿æ–‡ä»¶ä¸­å®šä¹‰çš„ email.html æ¨¡æ¿

      webhook_configs:
      - url: http://alert-webhook:5000/webhook
        send_resolved: true
    # é’ˆå¯¹äºé‚®ç®±å‘é€å‘Šè­¦
    #- name: 'email'
    #  email_configs:
    #  - to: 'barry.jiang@kerryprops.com'
    #    send_resolved: true
    #    html: '{{ template "email.html" . }}' # æ­¤å¤„é€šè¿‡ html æŒ‡å®šæ¨¡æ¿æ–‡ä»¶ä¸­å®šä¹‰çš„ email.html æ¨¡æ¿
    # é’ˆå¯¹äºé’‰é’‰å‘é€å‘Šè­¦
    #- name: 'dingtalk-webhook'
    #  webhook_configs:
    #  - url: http://alert-webhook:5000/webhook
    #    send_resolved: true

    # ä¸ä¸Šæ–‡é»˜è®¤çš„æ¥æ”¶å™¨ç›¸å¯¹åº” 
    - name: 'default' # # å…œåº•æ¥æ”¶å™¨
      email_configs:
      - to: 'barry.jiang@kerryprops.com'
        send_resolved: true  # æ¥å—å‘Šè­¦æ¢å¤çš„é€šçŸ¥


  template_email.tmpl: |-
    {{ define "email.html" }}
    <html>
    <body>
      {{- if gt (len .Alerts.Firing) 0 -}}
        {{- range .Alerts }}
          <h4 style="color:#FF0000">ğŸš¨ Prometheuså‘Šè­¦é€šçŸ¥</h4>
          <p><strong>ğŸ¤– å‘Šè­¦ç±»å‹</strong>ï¼š{{ .Labels.alertname }}</p>
          <p><strong>ğŸ“Œ å‘Šè­¦ç­‰çº§</strong>ï¼š<font color="#FF0000">{{ .Labels.severity }}</font></p>
          <p><strong>ğŸŒ é¡¹ç›®ç¯å¢ƒ</strong>ï¼š{{ .Labels.env }}</p>
          <p><strong>ğŸ–¥ å®ä¾‹åœ°å€</strong>ï¼š{{ .Labels.instance }}</p>
          <p><strong>ğŸ•˜ è§¦å‘æ—¶é—´</strong>ï¼š{{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}</p>
          <p><strong>ğŸ“ å‘Šè­¦è¯¦æƒ…</strong>ï¼š{{ .Annotations.description }}</p>
          <font color="#FF0000">â€¼ï¸ è¯·ç«‹å³å¤„ç†   â€¼ï¸</font>
          <p><a href="{{ .GeneratorURL }}">ğŸ“Š ç‚¹å‡»æŸ¥çœ‹æŒ‡æ ‡</a></p>
          <hr/>
        {{- end }}
      {{- else if gt (len .Alerts.Resolved) 0 -}}
        {{- range .Alerts }}
          <h4 style="color:#02b340">âœ… Prometheusæ¢å¤é€šçŸ¥</h4>
          <p><strong>ğŸ¤– å‘Šè­¦ç±»å‹</strong>ï¼š{{ .Labels.alertname }}</p>
          <p><strong>ğŸ“Œ å‘Šè­¦ç­‰çº§</strong>ï¼š<font color="#FF0000">{{ .Labels.severity }}</font></p>
          <p><strong>ğŸŒ é¡¹ç›®ç¯å¢ƒ</strong>ï¼š{{ .Labels.env }}</p>
          <p><strong>ğŸ–¥ å®ä¾‹åœ°å€</strong>ï¼š{{ .Labels.instance }}</p>
          <p><strong>ğŸ•˜ è§¦å‘æ—¶é—´</strong>ï¼š{{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}</p>
          <p><strong>ğŸ•˜ æ¢å¤æ—¶é—´</strong>ï¼š{{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}</p>
          <p><strong>ğŸ•˜ æ¢å¤å†…å®¹</strong>ï¼š{{ .Annotations.description }} </p>
          <font color="#02b340">ğŸ”„ çŠ¶æ€å·²æ¢å¤ ğŸ”„</font>
          <p><a href="{{ .GeneratorURL }}">ğŸ“Š ç‚¹å‡»æŸ¥çœ‹å†å²æŒ‡æ ‡</a></p>
          <hr/>
        {{- end }}
      {{- end }}
    </body>
    </html>
    {{ end }}


